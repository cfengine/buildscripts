#!/bin/sh -x

. "$(dirname "$0")"/functions
. detect-environment
. compile-options

#
# BE CAREFUL!
# This script will delete your CFEngine repositories if you are running it locally.
#
# Normally you would run autogen script first:
#   $ PROJECT=community ./buildscripts/build-scripts/autogen
#
# Then build tarballs with something like:
#   $ BUILD_TYPE=DEBUG ./buildscripts/build-scripts/bootstrap-tarballs
#
# This will create three tarballs:
# $ tree output/tarballs/
# output/tarballs/
# ├── cfengine-3.27.0a.55f1c495f.tar.gz
# ├── cfengine-masterfiles-3.27.0a.2655c7b89-1.pkg.tar.gz
# ├── cfengine-masterfiles-3.27.0a.2655c7b89.tar.gz
# └── sha256sums.61691.txt
#
# 1 directory, 4 files
#
# Then you can unpack these tarballs with this script:
#   $ PROJECT=community ./buildscripts/build-scripts/unpack-tarballs
#

for file in "$BASEDIR"/output/tarballs/cfengine-3.*.tar.gz; do
    SOURCE_TARBALL="$file"
done
if [ -z "$SOURCE_TARBALL" ]; then
    fatal "No matching CFEngine tarball found"
fi

for file in "$BASEDIR"/output/tarballs/cfengine-masterfiles*.tar.gz; do
    case "$file" in
    *pkg.tar.gz)
        # Don't match file ending with pkg.tar.gz
        ;;
    *)
        # This is the file we want
        MASTERFILES_TARBALL="$file"
        break
        ;;
    esac
done
if [ -z "$MASTERFILES_TARBALL" ]; then
    fatal "No matching masterfiles tarball found"
fi

# DELETE the git-checked-out directories, they are tainted with
# ./configure artifacts anyway.  The tarballs are unpacked and symlinked
# into place. That way unpacking of tarballs on all platforms is
# verified.

log_debug "Ensuring that core and masterfiles are not here"
sudo rm -rf "$BASEDIR/core" "$BASEDIR/masterfiles"
if [ -e "$BASEDIR/core/" ] || [ -e "$BASEDIR/masterfiles/" ]; then
    log_error 'core or masterfiles not deleted!'
    log_error "core: $(find "$BASEDIR/core/")"
    log_error "masterfiles: $(find "$BASEDIR/masterfiles/")"
    exit 1
fi

if [ "$PROJECT" = community ]; then
    log_debug "This is a community build: Ensuring that enterprise, nova and mission-portal are not here"
    sudo rm -rf "$BASEDIR/enterprise" "$BASEDIR/nova" "$BASEDIR/mission-portal"
fi

# NATIVE TAR is being used on purpose, and *not* GNU TAR.

log_debug "UNPACKING SOURCE TARBALL AND SYMLINKING core"
cd "$BASEDIR"
gzip -dc "$SOURCE_TARBALL" | tar -xf -
ln -s cfengine-3* core

log_debug "UNPACKING MASTERFILES TARBALL AND SYMLINKING masterfiles/"
gzip -dc "$MASTERFILES_TARBALL" | tar -xf -
ln -s cfengine-masterfiles-* masterfiles
