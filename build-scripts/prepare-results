#!/bin/sh

. `dirname "$0"`/functions
. detect-environment
. compile-options
. version

set -x

mkdir -p "$OUTDIR"

for dir in cfengine-community cfengine-nova cfengine-nova-hub; do
  if [ -d $BASEDIR/$dir ]; then
    case "$PACKAGING" in
      rpm)
        cp $BASEDIR/$dir/RPMS/*/*.rpm "$OUTDIR"
        cp $BASEDIR/$dir/RPMS/*.pkg.tar.gz "$OUTDIR"
        ;;
      deb)
        cp $BASEDIR/$dir/*.deb "$OUTDIR"
        cp $BASEDIR/$dir/pkg/*.pkg.tar.gz "$OUTDIR"
        ;;
      msi)
        cp $BASEDIR/$dir/*.msi "$OUTDIR"
        ;;
      solaris)
        cp $BASEDIR/$dir/*.pkg "$OUTDIR"
        ;;
      freebsd)
        cp build/$dir/pkg/*.tbz "$OUTDIR"
        ;;
      hpux)
        cp $BASEDIR/$dir/pkg/*.depot "$OUTDIR"
        ;;
      lpp)
        cp $BASEDIR/$dir/RPMS/*/*.rpm "$OUTDIR"
        cp $HOME/lppdir/out/*.bff "$OUTDIR"
        ;;
      *)
        echo "Unknown packaging system: $PACKAGING"
        exit 1;;
    esac
    #cp $BASEDIR/$dir/*.generic-pkg.tar.gz "$OUTDIR"
  fi
done

for project in `projects_to_test`; do
  if [ -f $BASEDIR/$project/tests/acceptance/summary.log ]; then
    cp $BASEDIR/$project/tests/acceptance/summary.log "$OUTDIR"/$project-summary.log
    cp $BASEDIR/$project/tests/acceptance/test.log "$OUTDIR"/$project-test.log
    cp $BASEDIR/$project/tests/acceptance/test.xml "$OUTDIR"/$project-test.xml
  fi
  set -x # debug to show what's going on here
# this probably won't work if TESTMACHINE=chroot
  cf_core_files=$(find "$BASEDIR/$project" -name 'core*' -type f -exec file {} \; 2>/dev/null | grep "core file" | grep "cf-" | cut -d' ' -f1 | sed 's/:$//')
  for core_file in $cf_core_files; do
    execfn=$(file "$core_file" | sed 's/,/\n/g' | grep execfn | cut -d: -f2 | sed "s/[' ]//g")
    exe="$(realpath "$execfn")"
    "$BASEDIR/$project"/libtool --mode=execute gdb --core="$core_file" -batch -ex bt
  done
done
