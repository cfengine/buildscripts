#!/bin/sh

#
# This script tests that the "make dist" target works on the core and masterfiles repositories on different platforms.
# THESE TARBALLS ARE NOT MEANT TO BE RELEASED!
#
# The tarballs that we release are built on a dedicated build host in the bootstrap-tarballs script.
# This script, on the other hand, is meant to be run on all hosts to make sure that make dist works everywhere.
# However, it's currently only used in our GitHub workflows and is not a part of the Jenkins PR pipeline (I think).
#
# The source tarballs a built into $OUTDIR (defined in the functions script).
#
# The script expects the following repositories to exist side by side:
# .
# ├── buildscripts
# ├── core
# └── masterfiles
#
# The script can be run as follows:
# ```
# $ ./buildscripts/build-scripts/generate-source-tarballs
# ```
#

. "$(dirname "$0")"/functions
. detect-environment
. compile-options


for repo in core masterfiles; do
    log_debug "Running target make dist in $repo repository..."
    (cd $repo && run_and_print_on_failure "$MAKE" V=1 dist)
done


# Copy to the directory that's being uploaded to buildcache

mkdir -p "$OUTDIR"
cp core/*.tar.gz masterfiles/*.tar.gz "$OUTDIR"
rm core/*.tar.gz masterfiles/*.tar.gz


echo '
The source tarballs here are generated in each and every
buildslave. THIS IS NOT THE TARBALL TO BE RELEASED! This is only to make
sure that "make dist" works everywhere.

The release tarball is generated from the "bootstrap-*-community"
jenkins jobs, running only on one buildslave. It should be located under
the "output/tarballs" directory of that job.
'    > "$OUTDIR"/TARBALLS.txt
